<!DOCTYPE html><html lang="en"><head><title>ext/framework</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="ext/framework"><meta name="groc-project-path" content="src/ext/framework.coffee"><meta name="groc-github-url" content="https://github.com/PaulLeCam/slob-client"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/PaulLeCam/slob-client/blob/master/src/ext/framework.coffee">src/ext/framework.coffee</a></div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><h1 id="framework">framework</h1>

<p>The framework module extends functionalities from the core for the needs of the application.</p></div></div><div class="code"><div class="wrapper"><span class="nx">define</span> <span class="p">[</span>
  <span class="s">&quot;core/util&quot;</span>
  <span class="s">&quot;core/dom&quot;</span>
  <span class="s">&quot;core/mvc&quot;</span>
  <span class="s">&quot;core/template&quot;</span>
  <span class="s">&quot;core/routing&quot;</span>
  <span class="s">&quot;core/store&quot;</span>
  <span class="s">&quot;core/dev&quot;</span>
<span class="p">],</span> <span class="nf">(util, dom, mvc, template, routing, Store, dev) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="template-extension">Template extension</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Local store for subviews</p></div></div><div class="code"><div class="wrapper">  <span class="nv">subviews = </span><span class="k">new</span> <span class="nx">Store</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add a "safe" helper to render raw HTML</p></div></div><div class="code"><div class="wrapper">  <span class="nx">template</span><span class="p">.</span><span class="nx">registerHelper</span> <span class="s">&quot;safe&quot;</span><span class="p">,</span> <span class="nf">(html) -&gt;</span>
    <span class="k">new</span> <span class="nx">template</span><span class="p">.</span><span class="nx">SafeString</span> <span class="nx">html</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add a view to the local store and return a DOM element that we can identify</p></div></div><div class="code"><div class="wrapper">  <span class="nv">template.addSubView = </span><span class="nf">(view) -&gt;</span>
    <span class="nx">subviews</span><span class="p">.</span><span class="nx">set</span> <span class="nx">view</span><span class="p">.</span><span class="nx">cid</span><span class="p">,</span> <span class="nx">view</span>
    <span class="k">new</span> <span class="nx">template</span><span class="p">.</span><span class="nx">SafeString</span> <span class="s">&quot;&lt;view data-cid=\&quot;</span><span class="si">#{</span> <span class="nx">view</span><span class="p">.</span><span class="nx">cid</span> <span class="si">}</span><span class="s">\&quot;&gt;&lt;/view&gt;&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Return the DOM element of a stored view and delete it from the store</p></div></div><div class="code"><div class="wrapper">  <span class="nv">template.renderSubView = </span><span class="nf">(cid) -&gt;</span>
    <span class="k">if</span> <span class="nv">view = </span><span class="nx">subviews</span><span class="p">.</span><span class="nx">get</span> <span class="nx">cid</span>
      <span class="nx">subviews</span><span class="p">.</span><span class="nx">delete</span> <span class="nx">cid</span>
      <span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span>
    <span class="k">else</span>
      <span class="nx">dev</span><span class="p">.</span><span class="nx">warn</span> <span class="s">&quot;Could not render subView </span><span class="si">#{</span> <span class="nx">cid</span> <span class="si">}</span><span class="s">&quot;</span>
      <span class="s">&quot;&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Render all subviews present in a DOM element identified by a jQuery object</p></div></div><div class="code"><div class="wrapper">  <span class="nv">template.renderSubViews = </span><span class="nf">($el) -&gt;</span>
    <span class="nx">$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&quot;view&quot;</span><span class="p">).</span><span class="nx">each</span> <span class="nf">(i, view) -&gt;</span>
      <span class="nv">$view = </span><span class="nx">dom</span><span class="p">.</span><span class="nx">find</span> <span class="nx">view</span><span class="p">,</span> <span class="nx">$el</span>
      <span class="nx">$view</span><span class="p">.</span><span class="nx">replaceWith</span> <span class="nx">template</span><span class="p">.</span><span class="nx">renderSubView</span> <span class="nx">$view</span><span class="p">.</span><span class="nx">data</span> <span class="s">&quot;cid&quot;</span>

  <span class="nx">template</span><span class="p">.</span><span class="nx">registerHelper</span> <span class="s">&quot;subView&quot;</span><span class="p">,</span> <span class="nx">template</span><span class="p">.</span><span class="nx">addSubView</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="router-extension">Router extension</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="k">class</span> <span class="nx">Router</span> <span class="k">extends</span> <span class="nx">routing</span><span class="p">.</span><span class="nx">Router</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Load a page module an call its <code>run()</code> function with the specified arguments,
passing it the name of the previous page</p></div></div><div class="code"><div class="wrapper">    <span class="nv">loadPage: </span><span class="nf">(page, args = []) -&gt;</span>
      <span class="nv">args = </span><span class="p">[].</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span> <span class="nx">args</span><span class="p">,</span> <span class="mi">0</span>
      <span class="nx">args</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">@previous</span>
      <span class="nx">require</span> <span class="p">[</span><span class="s">&quot;pages/</span><span class="si">#{</span> <span class="nx">page</span> <span class="si">}</span><span class="s">&quot;</span><span class="p">],</span> <span class="nf">(run) -&gt;</span>
        <span class="nx">run</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">run</span><span class="p">,</span> <span class="nx">args</span>
      <span class="vi">@previous = </span><span class="nx">page</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set the current page and navigate to a specific URL</p></div></div><div class="code"><div class="wrapper">    <span class="nv">setPage: </span><span class="nf">(page = &quot;home&quot;, url = &quot;/&quot;) -&gt;</span>
      <span class="vi">@previous = </span><span class="nx">page</span>
      <span class="nx">@navigate</span> <span class="nx">url</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="mvc-extension">MVC extension</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="k">class</span> <span class="nx">Model</span> <span class="k">extends</span> <span class="nx">mvc</span><span class="p">.</span><span class="nx">Model</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Each Model class must have its own store of instances</p></div></div><div class="code"><div class="wrapper">    <span class="nv">store: </span><span class="k">new</span> <span class="nx">Store</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>When we instanciate a model, we check in the store if it is not already present.
If this is the case, we silently update its data.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">constructor: </span><span class="nf">(params = {}) -&gt;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">id = </span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="o">or</span> <span class="nx">params</span><span class="p">.</span><span class="nx">cid</span><span class="p">)</span> <span class="o">and</span> <span class="nv">self = </span><span class="nx">@store</span><span class="p">.</span><span class="nx">get</span> <span class="nx">id</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">set</span> <span class="nx">params</span><span class="p">,</span> <span class="nv">silent: </span><span class="kc">yes</span>
        <span class="k">return</span> <span class="nx">self</span>

      <span class="k">super</span> <span class="nx">params</span>
      <span class="nv">key = </span><span class="nx">@id</span> <span class="o">?</span> <span class="nx">@cid</span>
      <span class="nx">@store</span><span class="p">.</span><span class="nx">set</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Alias <code>trigger()</code> to <code>emit()</code> for consistency with other events objects</p></div></div><div class="code"><div class="wrapper">    <span class="nv">emit: </span><span class="nf">-&gt;</span>
      <span class="nx">@trigger</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">arguments</span>

    <span class="nv">parse: </span><span class="nf">(res) -&gt;</span>
      <span class="k">if</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span> <span class="o">is</span> <span class="s">&quot;OK&quot;</span> <span class="k">then</span> <span class="nx">res</span><span class="p">.</span><span class="nx">data</span> <span class="k">else</span> <span class="p">{}</span>

  <span class="k">class</span> <span class="nx">Collection</span> <span class="k">extends</span> <span class="nx">mvc</span><span class="p">.</span><span class="nx">Collection</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Alias <code>trigger()</code> to <code>emit()</code> for consistency with other events objects</p></div></div><div class="code"><div class="wrapper">    <span class="nv">emit: </span><span class="nf">-&gt;</span>
      <span class="nx">@trigger</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">arguments</span>

    <span class="nv">parse: </span><span class="nf">(res) -&gt;</span>
      <span class="k">if</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span> <span class="o">is</span> <span class="s">&quot;OK&quot;</span> <span class="k">then</span> <span class="nx">res</span><span class="p">.</span><span class="nx">data</span> <span class="k">else</span> <span class="p">{}</span>

  <span class="k">class</span> <span class="nx">View</span> <span class="k">extends</span> <span class="nx">mvc</span><span class="p">.</span><span class="nx">View</span>

    <span class="nv">initialize: </span><span class="nf">(params = {}) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If the model parameter is an object and not an actual instance of a Model, we try to set it</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">params</span><span class="p">.</span><span class="nx">model</span> <span class="o">and</span> <span class="o">not</span> <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">model</span> <span class="k">instanceof</span> <span class="nx">mvc</span><span class="p">.</span><span class="nx">Model</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">@Model</span> <span class="k">then</span> <span class="vi">@model = </span><span class="k">new</span> <span class="nx">@Model</span> <span class="nx">params</span><span class="p">.</span><span class="nx">model</span>
        <span class="k">else</span> <span class="nx">dev</span><span class="p">.</span><span class="nx">error</span> <span class="s">&quot;Invalid model&quot;</span><span class="p">,</span> <span class="nx">params</span><span class="p">.</span><span class="nx">model</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If the collection parameter is an object and not an actual instance of a Collection, we try to set it</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">params</span><span class="p">.</span><span class="nx">collection</span> <span class="o">and</span> <span class="o">not</span> <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">collection</span> <span class="k">instanceof</span> <span class="nx">mvc</span><span class="p">.</span><span class="nx">Collection</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">@Collection</span> <span class="k">then</span> <span class="vi">@collection = </span><span class="k">new</span> <span class="nx">@Collection</span> <span class="nx">params</span><span class="p">.</span><span class="nx">collection</span>
        <span class="k">else</span> <span class="nx">dev</span><span class="p">.</span><span class="nx">error</span> <span class="s">&quot;Invalid collection&quot;</span><span class="p">,</span> <span class="nx">params</span><span class="p">.</span><span class="nx">collection</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If we have a cid but no el parameter, we try to get the element from the DOM</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="o">not</span> <span class="nx">params</span><span class="p">.</span><span class="nx">el</span> <span class="o">and</span> <span class="nx">params</span><span class="p">.</span><span class="nx">cid</span>
        <span class="nv">$el = </span><span class="nx">dom</span><span class="p">.</span><span class="nx">find</span> <span class="s">&quot;[data-view=</span><span class="si">#{</span> <span class="nx">params</span><span class="p">.</span><span class="nx">cid</span> <span class="si">}</span><span class="s">]&quot;</span>
        <span class="nx">@setElement</span> <span class="nx">$el</span> <span class="k">if</span> <span class="nx">$el</span><span class="p">.</span><span class="nx">length</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Alias <code>trigger()</code> to <code>emit()</code> for consistency with other events objects</p></div></div><div class="code"><div class="wrapper">    <span class="nv">emit: </span><span class="nf">-&gt;</span>
      <span class="nx">@trigger</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">arguments</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The <code>renderer()</code> set the HTML content for the element and render eventual associated subviews</p></div></div><div class="code"><div class="wrapper">    <span class="nv">renderer: </span><span class="nf">(html) -&gt;</span>
      <span class="nx">@$el</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;data-view&quot;</span><span class="p">,</span> <span class="nx">@cid</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">html</span> <span class="nx">html</span>
      <span class="nx">template</span><span class="p">.</span><span class="nx">renderSubViews</span> <span class="nx">@$el</span>
      <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="widget">Widget</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="k">class</span> <span class="nx">Widget</span> <span class="k">extends</span> <span class="nx">View</span>

    <span class="nv">contructor: </span><span class="nf">(options) -&gt;</span>
      <span class="k">super</span> <span class="nx">options</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Make sure the widget does not start when instanciated.</p></div></div><div class="code"><div class="wrapper">      <span class="nx">@stop</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>When starting a widget for the first time, we render it.
Then, later calls to the function will ensure events are bound.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">start: </span><span class="nf">-&gt;</span>
      <span class="k">if</span> <span class="nx">@rendered</span> <span class="k">then</span> <span class="nx">@delegateEvents</span><span class="p">()</span>
      <span class="k">else</span>
        <span class="nx">@render</span><span class="p">()</span>
        <span class="vi">@rendered = </span><span class="kc">yes</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Alias to <code>undelegateEvents()</code></p></div></div><div class="code"><div class="wrapper">    <span class="nv">stop: </span><span class="nf">-&gt;</span>
      <span class="nx">@undelegateEvents</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="public-api">Public API</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nv">mvc = </span><span class="p">{</span><span class="nx">Model</span><span class="p">,</span> <span class="nx">View</span><span class="p">,</span> <span class="nx">Collection</span><span class="p">}</span>
  <span class="nv">routing.Router = </span><span class="nx">Router</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Expose mvc, template, routing objects and Widget class</p></div></div><div class="code"><div class="wrapper">  <span class="p">{</span><span class="nx">mvc</span><span class="p">,</span> <span class="nx">template</span><span class="p">,</span> <span class="nx">routing</span><span class="p">,</span> <span class="nx">Widget</span><span class="p">}</span></div></div></div></div></body></html>