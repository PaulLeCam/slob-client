<!DOCTYPE html><html lang="en"><head><title>ext/widgets</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="ext/widgets"><meta name="groc-project-path" content="src/ext/widgets.coffee"><meta name="groc-github-url" content="https://github.com/PaulLeCam/slob-client"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/PaulLeCam/slob-client/blob/master/src/ext/widgets.coffee">src/ext/widgets.coffee</a></div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><h1 id="widgets">widgets</h1>

<p>The Widgets module manages widgets lifecycles by presenting an API to asynchronously load and initialize them
and synchronously start, stop and remove them.
By keeping both references by widgets types and DOM elements, it offers the possibility to
start and stop all widgets of a certain type, or for a certain DOM element, at once.</p></div></div><div class="code"><div class="wrapper"><span class="nx">define</span> <span class="p">[</span>
  <span class="s">&quot;core/dev&quot;</span>
  <span class="s">&quot;core/dom&quot;</span>
  <span class="s">&quot;core/promise&quot;</span>
  <span class="s">&quot;core/store&quot;</span>
  <span class="s">&quot;core/util&quot;</span>
<span class="p">],</span> <span class="nf">(dev, dom, promise, Store, util) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>We keep references to widgets in two stores: one for widgets types and the other for DOM elements</p></div></div><div class="code"><div class="wrapper">  <span class="nv">typesStore = </span><span class="k">new</span> <span class="nx">Store</span>
  <span class="nv">elsStore = </span><span class="k">new</span> <span class="nx">Store</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Promise wrapper for <code>require()</code></p></div></div><div class="code"><div class="wrapper">  <span class="nv">load: </span><span class="nf">(type) -&gt;</span>
    <span class="nv">dfd = </span><span class="nx">promise</span><span class="p">.</span><span class="nx">deferred</span><span class="p">()</span>

    <span class="nx">require</span> <span class="p">[</span><span class="s">&quot;widgets/</span><span class="si">#{</span> <span class="nx">type</span> <span class="si">}</span><span class="s">&quot;</span><span class="p">],</span> <span class="nx">dfd</span><span class="p">.</span><span class="nx">resolve</span><span class="p">,</span> <span class="nf">(err) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>There was an error loading the widget</p></div></div><div class="code"><div class="wrapper">      <span class="nx">dev</span><span class="p">.</span><span class="nx">warn</span> <span class="s">&quot;Error trying to initialize widget `</span><span class="si">#{</span> <span class="nx">type</span> <span class="si">}</span><span class="s">`&quot;</span><span class="p">,</span> <span class="nx">err</span>
      <span class="nx">dfd</span><span class="p">.</span><span class="nx">reject</span> <span class="nx">err</span>

    <span class="nx">dfd</span><span class="p">.</span><span class="nx">promise</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>To initialize a widget, we need its type (the module to load) and its parameters hash.
If the <code>options</code> argument is a string, we consider it is the DOM element to attach the widget to.
Because the widget module may require to be loaded, the function returns a promise.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">initialize: </span><span class="nf">(type, options) -&gt;</span>
    <span class="nv">dfd = </span><span class="nx">promise</span><span class="p">.</span><span class="nx">deferred</span><span class="p">()</span>

    <span class="nx">@load</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">dfd</span><span class="p">.</span><span class="nx">reject</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">done</span> <span class="nf">(Widget) -&gt;</span>
        <span class="nv">options = </span><span class="p">{</span><span class="nv">el: </span><span class="nx">options</span><span class="p">}</span> <span class="k">unless</span> <span class="nx">util</span><span class="p">.</span><span class="nx">isObject</span> <span class="nx">options</span>
        <span class="nv">w = </span><span class="k">new</span> <span class="nx">Widget</span> <span class="nx">options</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get widget types references associated to the DOM element, or create a new one if not already set</p></div></div><div class="code"><div class="wrapper">        <span class="nx">elsStore</span><span class="p">.</span><span class="nx">set</span> <span class="nx">options</span><span class="p">.</span><span class="nx">el</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Store</span> <span class="k">unless</span> <span class="nx">elsStore</span><span class="p">.</span><span class="nx">has</span> <span class="nx">options</span><span class="p">.</span><span class="nx">el</span>
        <span class="nv">elTypes = </span><span class="nx">elsStore</span><span class="p">.</span><span class="nx">get</span> <span class="nx">options</span><span class="p">.</span><span class="nx">el</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add type to element's store</p></div></div><div class="code"><div class="wrapper">        <span class="nx">elTypes</span><span class="p">.</span><span class="nx">set</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">w</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get widget elements references associated to the type, or create a new one if not already set</p></div></div><div class="code"><div class="wrapper">        <span class="nx">typesStore</span><span class="p">.</span><span class="nx">set</span> <span class="nx">type</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Store</span> <span class="k">unless</span> <span class="nx">typesStore</span><span class="p">.</span><span class="nx">has</span> <span class="nx">type</span>
        <span class="nv">typeEls = </span><span class="nx">typesStore</span><span class="p">.</span><span class="nx">get</span> <span class="nx">type</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add element to type's store</p></div></div><div class="code"><div class="wrapper">        <span class="nx">typeEls</span><span class="p">.</span><span class="nx">set</span> <span class="nx">options</span><span class="p">.</span><span class="nx">el</span><span class="p">,</span> <span class="nx">w</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Resolve with the widget instance</p></div></div><div class="code"><div class="wrapper">        <span class="nx">dfd</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">w</span>

    <span class="nx">dfd</span><span class="p">.</span><span class="nx">promise</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The <code>start()</code> function can be used to start a single widget by setting its type and DOM element.
If the widget is not already created, it will be by calling the <code>initialize()</code> function, that takes the same parameters.
It is also possible to start all initialized widgets of a certain type by setting the second argument to <code>*</code>,
or to start all initialized widgets attached to a DOM element by setting the first argument to <code>*</code>.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">start: </span><span class="nf">(type, options) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check for wrong parameters</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="o">not</span> <span class="nx">type</span><span class="o">?</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">options</span><span class="o">?</span> <span class="o">or</span> <span class="nx">type</span> <span class="o">is</span> <span class="s">&quot;*&quot;</span> <span class="o">and</span> <span class="nx">options</span> <span class="o">is</span> <span class="s">&quot;*&quot;</span>
      <span class="nx">dev</span><span class="p">.</span><span class="nx">warn</span> <span class="s">&quot;Wrong parameters to start widget&quot;</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">options</span>
      <span class="k">return</span> <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Re-start all widgets of the specified type</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">options</span> <span class="o">is</span> <span class="s">&quot;*&quot;</span>
      <span class="k">if</span> <span class="nv">typeEls = </span><span class="nx">typesStore</span><span class="p">.</span><span class="nx">get</span> <span class="nx">type</span>
        <span class="nx">w</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span> <span class="k">for</span> <span class="nx">w</span> <span class="k">in</span> <span class="nx">typeEls</span><span class="p">.</span><span class="nx">values</span><span class="p">()</span>

    <span class="k">else</span>
      <span class="nv">options = </span><span class="p">{</span><span class="nv">el: </span><span class="nx">options</span><span class="p">}</span> <span class="k">unless</span> <span class="nx">util</span><span class="p">.</span><span class="nx">isObject</span> <span class="nx">options</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Try to get widgets types associated to the specified DOM element</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nv">elTypes = </span><span class="nx">elsStore</span><span class="p">.</span><span class="nx">get</span> <span class="nx">options</span><span class="p">.</span><span class="nx">el</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Re-start all widgets for element</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="nx">type</span> <span class="o">is</span> <span class="s">&quot;*&quot;</span>
          <span class="nx">w</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span> <span class="k">for</span> <span class="nx">w</span> <span class="k">in</span> <span class="nx">elTypes</span><span class="p">.</span><span class="nx">values</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Re-start single widget</p></div></div><div class="code"><div class="wrapper">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nv">w = </span><span class="nx">elTypes</span><span class="p">.</span><span class="nx">get</span> <span class="nx">type</span><span class="p">)</span> <span class="k">then</span> <span class="nx">w</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Initialize and start new widget</p></div></div><div class="code"><div class="wrapper">        <span class="k">else</span> <span class="nx">@initialize</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">options</span><span class="p">).</span><span class="nx">done</span> <span class="nf">(w) -&gt;</span> <span class="nx">w</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>There are no widgets yet associated to this DOM element, let's initialize and start new widget</p></div></div><div class="code"><div class="wrapper">      <span class="k">else</span> <span class="nx">@initialize</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">options</span><span class="p">).</span><span class="nx">done</span> <span class="nf">(w) -&gt;</span> <span class="nx">w</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>
    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The <code>stop()</code> function can be used to stop a single widget by setting its type and DOM element.
It is also possible to stop all widgets of a certain type by setting the second argument to <code>*</code>,
or to stop all widgets attached to a DOM element by setting the first argument to <code>*</code>.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">stop: </span><span class="nf">(type, el) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check for wrong parameters</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="o">not</span> <span class="nx">type</span><span class="o">?</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">el</span><span class="o">?</span> <span class="o">or</span> <span class="nx">type</span> <span class="o">is</span> <span class="s">&quot;*&quot;</span> <span class="o">and</span> <span class="nx">el</span> <span class="o">is</span> <span class="s">&quot;*&quot;</span>
      <span class="nx">dev</span><span class="p">.</span><span class="nx">warn</span> <span class="s">&quot;Wrong parameters to stop widget&quot;</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">el</span>
      <span class="k">return</span> <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Stop all widgets of the specified type</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">el</span> <span class="o">is</span> <span class="s">&quot;*&quot;</span>
      <span class="k">if</span> <span class="nv">typeEls = </span><span class="nx">typesStore</span><span class="p">.</span><span class="nx">get</span> <span class="nx">type</span>
        <span class="nx">w</span><span class="p">.</span><span class="nx">stop</span><span class="p">()</span> <span class="k">for</span> <span class="nx">w</span> <span class="k">in</span> <span class="nx">typeEls</span><span class="p">.</span><span class="nx">values</span><span class="p">()</span>

    <span class="k">else</span>
      <span class="k">if</span> <span class="nv">elTypes = </span><span class="nx">elsStore</span><span class="p">.</span><span class="nx">get</span> <span class="nx">el</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Stop all widgets for element</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="nx">type</span> <span class="o">is</span> <span class="s">&quot;*&quot;</span>
          <span class="nx">w</span><span class="p">.</span><span class="nx">stop</span><span class="p">()</span> <span class="k">for</span> <span class="nx">w</span> <span class="k">in</span> <span class="nx">elTypes</span><span class="p">.</span><span class="nx">values</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Stop single widget</p></div></div><div class="code"><div class="wrapper">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nv">w = </span><span class="nx">elTypes</span><span class="p">.</span><span class="nx">get</span> <span class="nx">type</span><span class="p">)</span> <span class="k">then</span> <span class="nx">w</span><span class="p">.</span><span class="nx">stop</span><span class="p">()</span>
    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Stop and empty HTML content</p></div></div><div class="code"><div class="wrapper">  <span class="nv">shutdown: </span><span class="nf">(type, el) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check for wrong parameters</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="o">not</span> <span class="nx">type</span><span class="o">?</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">el</span><span class="o">?</span> <span class="o">or</span> <span class="nx">type</span> <span class="o">is</span> <span class="s">&quot;*&quot;</span> <span class="o">and</span> <span class="nx">el</span> <span class="o">is</span> <span class="s">&quot;*&quot;</span>
      <span class="nx">dev</span><span class="p">.</span><span class="nx">warn</span> <span class="s">&quot;Wrong parameters to stop widget&quot;</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">el</span>
      <span class="k">return</span> <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Shutdown all widgets of the specified type</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">el</span> <span class="o">is</span> <span class="s">&quot;*&quot;</span>
      <span class="k">if</span> <span class="nv">typeEls = </span><span class="nx">typesStore</span><span class="p">.</span><span class="nx">get</span> <span class="nx">type</span>
        <span class="nx">w</span><span class="p">.</span><span class="nx">shutdown</span><span class="p">()</span> <span class="k">for</span> <span class="nx">w</span> <span class="k">in</span> <span class="nx">typeEls</span><span class="p">.</span><span class="nx">values</span><span class="p">()</span>

    <span class="k">else</span>
      <span class="k">if</span> <span class="nv">elTypes = </span><span class="nx">elsStore</span><span class="p">.</span><span class="nx">get</span> <span class="nx">el</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Shutdown all widgets for element</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="nx">type</span> <span class="o">is</span> <span class="s">&quot;*&quot;</span>
          <span class="nx">w</span><span class="p">.</span><span class="nx">shutdown</span><span class="p">()</span> <span class="k">for</span> <span class="nx">w</span> <span class="k">in</span> <span class="nx">elTypes</span><span class="p">.</span><span class="nx">values</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Shutdown single widget</p></div></div><div class="code"><div class="wrapper">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nv">w = </span><span class="nx">elTypes</span><span class="p">.</span><span class="nx">get</span> <span class="nx">type</span><span class="p">)</span> <span class="k">then</span> <span class="nx">w</span><span class="p">.</span><span class="nx">shutdown</span><span class="p">()</span>
    <span class="nx">@</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The <code>remove()</code> function removes all widgets for the specified DOM element and removes this element from the DOM.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">remove: </span><span class="nf">(el) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check for wrong parameters</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="o">not</span> <span class="nx">el</span><span class="o">?</span> <span class="o">or</span> <span class="nx">el</span> <span class="o">is</span> <span class="s">&quot;*&quot;</span>
      <span class="nx">dev</span><span class="p">.</span><span class="nx">warn</span> <span class="s">&quot;Wrong parameters to remove widget&quot;</span><span class="p">,</span> <span class="nx">el</span>
      <span class="k">return</span> <span class="nx">@</span>

    <span class="k">if</span> <span class="nv">elTypes = </span><span class="nx">elsStore</span><span class="p">.</span><span class="nx">get</span> <span class="nx">el</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get types references for DOM element</p></div></div><div class="code"><div class="wrapper">      <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">elTypes</span><span class="p">.</span><span class="nx">keys</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Remove widget</p></div></div><div class="code"><div class="wrapper">        <span class="nx">elTypes</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">remove</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Remove element from type's store</p></div></div><div class="code"><div class="wrapper">        <span class="nx">typesEl</span><span class="p">.</span><span class="nx">delete</span> <span class="nx">el</span> <span class="k">if</span> <span class="nv">typesEl = </span><span class="nx">typesStore</span><span class="p">.</span><span class="nx">get</span> <span class="nx">el</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Remove element from global store</p></div></div><div class="code"><div class="wrapper">      <span class="nx">elsStore</span><span class="p">.</span><span class="nx">delete</span> <span class="nx">el</span>
    <span class="k">else</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Remove the element from the DOM</p></div></div><div class="code"><div class="wrapper">      <span class="nx">sandbox</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">el</span><span class="p">).</span><span class="nx">remove</span><span class="p">()</span>
    <span class="nx">@</span></div></div></div></div></body></html>